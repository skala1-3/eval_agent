<!DOCTYPE html>
<html lang="{{ i18n.lang|default('ko') }}">
<head>
  <meta charset="utf-8" />
  <title>{{ company.name }} — {% if i18n.lang=='en' %}Consulting Report{% else %}투자 컨설팅 보고서{% endif %}</title>
  <style>
    @page { size: A4; margin: 16mm 14mm 18mm 14mm; }
    :root { --text:#111; --muted:#666; --line:#e5e5e5; --accent:#1f6feb; --ok:#198754; --warn:#c07d00; --bad:#c03221; --bg:#fff; --bg-lite:#f8f9fb; }
    html,body{ font-family:"Noto Sans CJK KR","Noto Sans KR","Malgun Gothic","Apple SD Gothic Neo","Segoe UI",Arial,sans-serif; color:var(--text); font-size:11pt; line-height:1.65; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    h1,h2,h3{ margin:0 0 .6em 0; } h1{font-size:20pt;} h2{font-size:14pt; border-bottom:2px solid var(--line); padding-bottom:6px;} h3{font-size:12.5pt; color:var(--muted);}
    p{ margin:0 0 12px 0; }
    ul{ margin:0 0 8px 20px; padding:0; } li{ margin:0 0 6px 0; }
    ul.bulleted{ margin:0 0 8px 22px; padding:0; list-style:disc; }
    ul.bulleted li{ margin:0 0 6px 0; }
    .muted{color:var(--muted);} .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:9pt;background:var(--bg-lite);}
    .good{color:var(--ok);} .warn{color:var(--warn);} .bad{color:var(--bad);}
    .grid-2{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px 10px;}
    .box{border:1px solid var(--line);border-radius:10px;padding:14px;background:#fff;}
    .scorebox{border-left:4px solid var(--accent);} .small{font-size:9.5pt;} .right{text-align:right;} .center{text-align:center;}
    .mb8{margin-bottom:8px;} .mb12{margin-bottom:12px;} .mb16{margin-bottom:16px;} .mb20{margin-bottom:20px;} .mb24{margin-bottom:24px;} .mt8{margin-top:8px;} .pagebreak{page-break-before:always;}
    table{width:100%;border-collapse:collapse;table-layout:fixed;} th,td{padding:9px 10px;border-bottom:1px solid var(--line);vertical-align:top;} th{background:#f5f7fb;text-align:left;}
    .td-xs{width:16mm;} .td-sm{width:22mm;} .td-md{width:42mm;} .td-lg{width:58mm;}
    .preline{white-space:pre-line;}
  </style>
</head>
<body>

  <!-- 헤더 -->
  <section class="mb20">
    <h1>{% if i18n.lang=='en' %}AI Financial Advisory — Consulting Report{% else %}AI Financial Advisory — 투자 컨설팅 보고서{% endif %}</h1>
    <div class="muted mb12">{{ generated_at }} · Query: “{{ query }}”</div>

    <div class="grid-2">
      <div class="box scorebox">
        <h2>{{ company.name }}</h2>
        <div class="kv mt8">
          <div class="muted">Website</div><div>{% if company.website %}<a href="{{ company.website }}">{{ company.website }}</a>{% else %}-{% endif %}</div>
          <div class="muted">Founded</div><div>{{ company.founded_year or "-" }}</div>
          <div class="muted">Stage</div><div>{{ company.stage or "-" }}</div>
          <div class="muted">Headcount</div><div>{{ company.headcount or "-" }}</div>
          <div class="muted">Region</div><div>{{ company.region or "-" }}</div>
          <div class="muted">Tags</div>
          <div>{% for t in company.tags or [] %}<span class="tag">{{ t }}</span>{% else %}<span class="muted">-</span>{% endfor %}</div>
        </div>
      </div>

      <div class="box">
        <h2>{% if i18n.lang=='en' %}Score Summary{% else %}요약(Score){% endif %}</h2>
        <div class="mb8">{{ i18n.labels.total }}: <strong style="font-size:16pt">{{ scorecard.total|round(2) }}</strong> / 10</div>
        <div class="mb8">{{ i18n.labels.confidence }}: <strong>{{ confidence_mean|round(2) }}</strong></div>
        <div class="mb12">
          {% if i18n.lang=='en' %}Decision{% else %}의사결정{% endif %}:
          {% if scorecard.decision == "invest" %}<span class="pill good">{{ scorecard.decision_label|default(i18n.labels.invest) }}</span>
          {% elif scorecard.decision == "conditional" %}<span class="pill warn">CONDITIONAL</span>
          {% else %}<span class="pill bad">{{ i18n.labels.hold }}</span>{% endif %}
        </div>
        <div class="small muted">조건: total ≥ 7.5 &amp; mean(confidence) ≥ 0.55</div>
      </div>
    </div>
  </section>

  <!-- 본문 -->
  <section class="mb24"><h2>Executive Summary</h2><p>{{ exec_summary }}</p></section>
  <section class="mb24"><h2>Competitive Position</h2><ul class="bulleted">{% for p in position_points %}<li>{{ p }}</li>{% else %}<li>정보 부족</li>{% endfor %}</ul></section>
  <section class="mb24"><h2>Risk &amp; Considerations</h2><ul class="bulleted">{% for r in risks %}<li>{{ r }}</li>{% else %}<li>정보 부족</li>{% endfor %}</ul></section>
  <section class="mb24"><h2>Investment Outlook</h2><p>{{ outlook }}</p></section>

  <!-- 강점/취약 -->
  <section class="mb24">
    <h2>{{ i18n.labels.narrative }}</h2>
    <div class="box mb16">
      <h3 class="muted">강점</h3>
      <ul class="bulleted">{% for b in strength_bullets %}<li>{{ b }}</li>{% else %}<li>정보 부족</li>{% endfor %}</ul>
    </div>
    <div class="box">
      <h3 class="muted">취약</h3>
      <ul class="bulleted">{% for b in weakness_bullets %}<li>{{ b }}</li>{% else %}<li>정보 부족</li>{% endfor %}</ul>
    </div>
  </section>

  <!-- 축별 점수 -->
  <section class="mb24">
    <div class="box">
      <h2>축별 점수(0–10) &amp; 신뢰도(0–1)</h2>
      <table class="small">
        <thead><tr><th style="width:28mm;">축(Key)</th><th class="right td-sm">점수</th><th class="right td-sm">{{ i18n.labels.confidence }}</th></tr></thead>
        <tbody>
        {% for item in scorecard["items"] %}
          <tr><td><code>{{ item.key }}</code></td><td class="right">{{ item.value|round(2) }}</td><td class="right">{{ item.confidence|round(2) }}</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <div class="pagebreak"></div>

  <!-- 경쟁 매트릭스 -->
  <section class="mb24">
    <h2>{{ i18n.labels.matrix }}</h2>
    <div class="box">
      <table class="small">
        <thead>
          <tr>
            <th class="td-lg">항목</th>
            {% for c in comp_matrix.cols %}
              <th>{{ c.name }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for r in comp_matrix.rows %}
            <tr>
              <td>{{ r.label }}</td>
              {% for c in comp_matrix.cols %}
                <td>{{ c.get(r.key, '—') }}</td>  <!-- dict 동적 키 접근 -->
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="small muted mt8">※ 값이 비어있는 칸은 공개 자료상 확인 불가를 의미합니다.</div>
    </div>
  </section>

  <!-- Evidence (total 제외) -->
  <section class="mb24">
    <h2>{{ i18n.labels.evidence }}</h2>
    {% set limit = evidence_limit_per_axis or 3 %}
    {% for item in items_for_evidence %}
      <div class="box mb16">
        <h3>■ {{ item.key }} — 점수 {{ item.value|round(2) }} / {{ i18n.labels.confidence }} {{ item.confidence|round(2) }}</h3>
        {% if item.evidence and item.evidence|length > 0 %}
          <table class="small">
            <thead><tr><th class="td-xs">강도</th><th>텍스트</th><th class="td-md">출처</th><th class="td-sm">날짜</th></tr></thead>
            <tbody>
            {% for ev in item.evidence[:limit] %}
              <tr>
                <td>{% if ev.strength == "strong" %}<span class="pill good">strong</span>{% elif ev.strength == "medium" %}<span class="pill warn">medium</span>{% else %}<span class="pill">weak</span>{% endif %}</td>
                <td>{{ ev.text }}</td>
                <td>
                  {% if ev.source_url and ev.source_url != '-' %}
                    <a href="{{ ev.source_url }}">{{ ev.domain or 'open' }}{% if ev.title and ev.title != '-' %} | {{ ev.title }}{% endif %}</a>
                  {% else %}
                    <span class="muted">-</span>
                  {% endif %}
                </td>
                <td>{{ ev.published_at or "-" }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
          {% if item.evidence|length > limit %}
            <div class="small muted mt8">(+{{ item.evidence|length - limit }} 더 있음)</div>
          {% endif %}
        {% else %}
          <div class="muted small">정보 부족</div>
        {% endif %}
      </div>
    {% endfor %}
  </section>

  <!-- 리스크 Heat -->
  <section class="mb24">
    <h2>{{ i18n.labels.risk_heat }}</h2>
    <div class="box">
      <table class="small">
        <thead><tr><th class="td-md">Risk</th><th class="td-sm">Likelihood</th><th class="td-sm">Impact</th><th>Mitigation</th></tr></thead>
        <tbody>
          {% for r in risk_heat.rows %}
            <tr>
              <td>{{ r.risk }}</td><td>{{ r.likelihood }}</td><td>{{ r.impact }}</td><td>{{ r.mitigation }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- 시나리오 -->
  <section class="mb24">
    <h2>{{ i18n.labels.scenarios }}</h2>
    <div class="box">
      <table class="small">
        <thead><tr><th class="td-sm">Scenario</th><th>Drivers</th><th>Catalysts</th><th>Blockers</th><th>Conditions</th></tr></thead>
        <tbody>
          <tr><td><strong>Upside</strong></td><td>{{ scenarios.upside.drivers }}</td><td>{{ scenarios.upside.catalysts }}</td><td>{{ scenarios.upside.blockers }}</td><td>{{ scenarios.upside.conditions }}</td></tr>
          <tr><td><strong>Base</strong></td><td>{{ scenarios.base.drivers }}</td><td>{{ scenarios.base.catalysts }}</td><td>{{ scenarios.base.blockers }}</td><td>{{ scenarios.base.conditions }}</td></tr>
          <tr><td><strong>Downside</strong></td><td>{{ scenarios.downside.drivers }}</td><td>{{ scenarios.downside.catalysts }}</td><td>{{ scenarios.downside.blockers }}</td><td>{{ scenarios.downside.conditions }}</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- 결론 -->
  <section class="mb24">
    <h2>결론(Conclusion)</h2>
    {% if scorecard.decision == "invest" %}
      <p class="mb8"><strong class="good">투자 권장</strong>. 총점 {{ scorecard.total|round(2) }} / 신뢰도 평균 충족.</p>
    {% elif scorecard.decision == "conditional" %}
      <p class="mb8"><strong class="warn">CONDITIONAL</strong>. 취약 축 보강 후 재평가 권장.</p>
    {% else %}
      <p class="mb8"><strong class="bad">보류</strong>. 임계 미만. 근거 보강 필요.</p>
    {% endif %}
    <p class="preline">{{ gpt_conclusion }}</p>
    <p class="small muted mt8">※ 본 보고서는 공개 자료 및 자동화된 RAG 기반 요약/평가에 근거하며, 최종 투자 의사결정은 별도의 실사(DD) 절차를 필요로 합니다.</p>
  </section>

</body>
</html>
